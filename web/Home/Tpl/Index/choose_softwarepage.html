<link rel="stylesheet" href="/Public/css/jquery-ui.css">
<link rel="stylesheet" href="/Public/css/choose_software.css">
<script src="/Public/js/jquery-1.9.1.js"></script>
<script src="/Public/js/jquery-ui.js"></script>

<div id="payment_div" class="payment_div">
	<div class="tc_title">
		<div class="title_span"></div>
	</div>
<div class="already_tc">
	<if condition="$_SESSION['account_id'] eq NULL ">
		<div class="usernotlogin">
			<div class="notlogintext">未登录用户，点击这里登陆</div>
			<div class="loginbuttondiv">
				<button type="button" id="userloginid"class="loginbutton" hidefocus="" >登陆</button>
			</div>
		</div>
		<div id="tc_endtip" class="tc_endtip"></div>
	<else />
		<if condition="$deadline_digit lt time() ">
			<div class="tc_expire" >您已经购买的套餐已经于<font size="5px" color="#ff2f05"><strong>{$deadline}</strong></font>过期。可选择下面套餐继续购买。</div>
			<else />
				<div class="purchased_display_type">
					<div class="purchased_head">套餐类型 :</div>
					<div id="tc_rank" class="tc_rank"> {$rank_str}</div>
					<div style="clear:both;"></div>
				</div>
				
				<div class="purchased_display_time">
					<div class="purchased_head">套餐到期时间:</div>
					<div id="tc_endstr" class="tc_endstr">{$deadline}</div>
					<div style="clear:both;"></div>
				</div>
				
				
				<div class="progress_time">
					<div id="tc_nowtip" class="tc_nowtip">
						<div class="nowtip_text">
							<p>今天：</p>
							<p>{$today_date}</p>
						</div>
					</div>
				
					<div id="tc_endtip" class="tc_endtip">
						<div class="endtip_text">
							<p>到期时间：</p>
							<p id="endtimestr">{$deadline}</p>
						</div>
					</div>
					<div style="clear:both;"></div>
					
					
					<div id="payed_progressbar" class="payed_progressbar">
						<div class="progress_item progress_leftest"></div>
						
						<div class="progress_item progress_right" id="progress_right">
							<div class="progress_item progress_left" id="progress_left"></div>
							<div class="progress_item progress_middle"></div>
						
						</div>
						<div class="progress_item progress_rightest"></div>
						<div style="clear:both;"></div>
					</div>
					<div style="clear:both;"></div>
				</div>
				
		</if>
	</if> 
	     
</div>


	<div class="tc_title">
			<div class="title_span2"></div>
	</div>
<div class="new_tc">
	<div class="tc_choose_div">
		<div class="tc_choose_head" >套餐选择：</div>
		<div class="tc_choose" id="basic_tc" rank-data="1" rank-price="{$user_meal[1]['price']}" rank-discount="{$user_meal[1]['price_discount']}">基本套餐</div>
		<div class="tc_choose" id="standard_tc" rank-data="2" rank-price="{$user_meal[2]['price']}" rank-discount="{$user_meal[2]['price_discount']}" >标准套餐</div>
		<div class="tc_choose" id="advanced_tc" rank-data="3" rank-price="{$user_meal[3]['price']}" rank-discount="{$user_meal[3]['price_discount']}" >高级套餐</div>
		<div style="clear:both;"></div>
	</div>
	
	<div class="choose_timediv">
		<div class="choose_time_head" >购买时长：</div>
						    		<div class="column">
							          			<span class="block mm" id="buy1" selfpos="1">
													<div >
														<span>1月</span>
													</div>
												</span>
												<span class="block mm" id="buy2" selfpos="2">
													<div>
														<span>2月</span>
													</div>
												</span>
												<span class="block mm" id="buy3" selfpos="3">
													<div>
														<span>3月</span>
													</div>
												</span>
												<span class="block mm" id="buy4" selfpos="4">
													<div>
														<span>4月</span>
													</div>
												</span>
												<span class="block mm" id="buy5" selfpos="5">
													<div>
														<span>5月</span>
													</div>
												</span>
												<span class="block mm" id="buy6" selfpos="6">
													<div>
														<span>6月</span>
													</div>
												</span>
												<span class="block mm" id="buy7" selfpos="7">
													<div>
														<span>7月</span>
													</div>
												</span>
												<span class="block mm" id="buy8" selfpos="8">
													<div>
														<span>8月</span>
													</div>
												</span>
												<span class="block mm" id="buy9" selfpos="9">
													<div>
														<span>9月</span>
													</div>
												</span>
												<span class="block mm" id="buy10" selfpos="10">
													<div>
														<span>10月</span>
													</div>
												</span>
												<span class="block mm" id="buy11" selfpos="11">
													<div>
														<span>11月</span>
													</div>
												</span>
												<span class="block mm" id="buy12" selfpos="12">
													<div>
														<span>12月</span>
													</div>
												</span>
												<span class="block mm" id="buy13" selfpos="13">
													<div>
														<span>2年</span>
													</div>
												</span>
												<span class="block yy" id="buy14" selfpos="14">
													<div>
														<span>3年</span>
													</div>
												</span>
						    		</div>
					    		</div>
	
	<div id="slider-range-min2" class="ordertime_slider2">
		<div class="slider-range slider-range_leftest"></div>
						
		<div class="slider-range slider-range_right" id="slider-range_right">
			<div class="slider-range slider-range_left" id="slider-range_left"></div>
			<div class="slider-range slider-range_middle"></div>
		
		</div>
		<div class="slider-range slider-range_rightest"></div>
		<div style="clear:both;"></div>
	</div>
	<div id="slider-range-min" class="ordertime_slider"></div>
	
	<div class="cost_formula">
		<div class="cost_formula_head" >  费用计算：</div>
		<div id="cost_detail" class="cost_detail">
			0
		</div>
	</div>
	
	
	<div class="cost">
		<div class="cost_head" >  费用总计：</div>
		<div class="cost_num">
			<div id="amount" class="cost_money" style="border:0; color:#f6931f; font-weight:bold;">0元</div>
		</div>
	</div>
	
	
	
	<div class="cost_formula">
		<div class="cost_formula_head" >详细说明：</div>
		<div class="cost_formula_content">最终价钱 = 新购买时长的套餐价钱  + (现有套餐剩余天数 / 30 ) * 套餐升级的差价  </div>
	</div>

</div>

<div class="buydiv">
	<button id="buy_immediately" class="uc-button" type="button" hidefocus="" >立即购买</button>
</div>
</div>


<input type="hidden" id="account_id" value='{$_SESSION["account_id"]}' />
<input type="hidden" id="deadline" value='{$deadline_digit}' />
<input type="hidden" id="rank" value='{$rank}' />
<input type="hidden" id="purchased_tc_price" value="{$user_meal[$rank]['price']}" />


<script type="text/javascript">
	
		$("#test").click(function(e){
    	var positionX=e.originalEvent.x-$(this).offset().left||e.originalEvent.layerX-$(this).offset().left||0;//获取当前鼠标相对img的x坐标
    	var positionY=e.originalEvent.y-$(this).offset().top||e.originalEvent.layerY-$(this).offset().top||0;//获取当前鼠标相对img的y坐标，（以下用不着，可删除）
    	alert(positionX+":"+positionY);
		});
	
	
	var buy_rank 	= 0;
	var rank_price	= 0;
	var rank_discount = 1;
	var buy_month 	= 0;
	var price		= 0; // 最后的总价
	var upgrade_money = 0;
	
	var start_date = Math.ceil(new Date().getTime()/1000);
	var deadline = parseInt($("#deadline").val());
	if(!isNaN(deadline)){
		start_date = deadline;
	}
	
	var end_date = start_date;
    
    
	var current_rank = parseInt($("#rank").val());
	if(isNaN(current_rank)){
		current_rank = 0;
	}
	
	
	
	// 初始化进度条的右边
	$("#progress_right").css({"background": 'url(/Public/image/purchase/gray.png)'});
	if(current_rank == 1){
		$("#progress_right").css({"background": 'url(/Public/image/purchase/blue.png)'});
	}
	if(current_rank == 2){
		$("#progress_right").css({"background": 'url(/Public/image/purchase/green.png)'});
	}
	if(current_rank == 3){
		$("#progress_right").css({"background": 'url(/Public/image/purchase/gold.png)'});
	}
	
	// 初始化套餐div
	function init_tcdiv(){
		$(".tc_choose").each(function(i){
			var choose_rank = current_rank;
			if(current_rank == 0){
				choose_rank = 1;
			}
			var rank_data = parseInt($(this).attr("rank-data"));
			if(rank_data == choose_rank){
				$(this).css({"border-color":"#ffa200"});
    			
    			buy_rank 		= $(this).attr("rank-data");
    			rank_price 		= parseFloat($(this).attr("rank-price"));
    			rank_discount 	= parseFloat($(this).attr("rank-discount"));
    			
    			if(rank_data == 1){
    				$(this).css({"background":"#8ddffd"});
    				
    			}
    			if(rank_data == 2){
    				$(this).css({"background":"#97fe80"});
    			}
    			if(rank_data == 3){
    				$(this).css({"background":"#fee85e"});
    			}
    			
    			
			}
			if(rank_data < choose_rank){
				$(this).css({"cursor":"default"});
				
				// 字体变成灰色
				$(this).css({"color":"#c2c1c1"});
			}
	    });
	}
	init_tcdiv();
	
	// 登陆按钮跳转
	$("#userloginid").click(function(){
		window.location.href="__APP__/User/login";
	});
	
	
	
        
    // 进度条滚动起来
    function updateProgressbarValue(){
    	var newValue = $("#progress_left").css("width");
    	newValue  = parseInt(newValue.substr(0, newValue.length-2));
    	newValue = newValue +5;
    	$("#progress_left").css({'width':newValue+'px'});
    	
    	// 移动上面的tips
    	var tipleft = $("#tc_nowtip").css("margin-left");
    	tipleft = parseInt(tipleft.substr(0, tipleft.length-2));
    	tipleft = tipleft +5;
    	$("#tc_nowtip").css({'margin-left':tipleft+'px'});
    	
    	if(newValue<=300){
    		setTimeout(updateProgressbarValue,1);
    	}
    }
    updateProgressbarValue();
    
    
    
    
    
    var endtips_right = $("#tc_endtip").css('margin-right');
    
    // 当拖动购买时长的控件的时候，改变进度条的长度
    function change_progress_width(value){
		var new_progress_width = progress_width + value;
		var progress_left = progressbar_value;
		var left_width = progress_width * progress_left / 100;
		var new_progress_left = left_width * 100 / new_progress_width;
		
    }
    
    
    // move end time tips
    function move_endtips(value){
    	var endtips_right_value = endtips_right.substr(0, endtips_right.length-2);
    	var new_right = parseInt(endtips_right_value - value);
    	$("#tc_endtip").css({'margin-right':new_right+'px'});
    }
    
    // 套餐选择
    $(".tc_choose").each(function(i){
    	$(this).click(function(){
    		var rank_data = parseInt($(this).attr("rank-data"));
			if(rank_data < current_rank){
				return;
			}
				
    		$(".tc_choose").each(function(n)
    		{
    			$(this).css({"border-color":""});
    			$(this).css({"background":""});
    		});
    		
    		if(rank_data == 1){
    			$(this).css({"border-color":"#ffa200"});
				$(this).css({"background":"#8ddffd"});
				$("#progress_right").css({"background": 'url(/Public/image/purchase/blue.png)'});
			}
			if(rank_data == 2){
				$(this).css({"border-color":"#ffa200"});
				$(this).css({"background":"#97fe80"});
				$("#progress_right").css({"background": 'url(/Public/image/purchase/green.png)'});
			}
			if(rank_data == 3){
				$(this).css({"border-color":"#ffa200"});
				$(this).css({"background":"#fee85e"});
				$("#progress_right").css({"background": 'url(/Public/image/purchase/gold.png)'});
			}

    		buy_rank 		= $(this).attr("rank-data");
    		rank_price 		= parseFloat($(this).attr("rank-price"));
    		rank_discount 	= parseFloat($(this).attr("rank-discount"));
    		
    		change_price();
    	});
    });
        
        
  // 拉扯的时间条
	$(function() {
		$( "#slider-range-min" ).slider({
      		range: "min",
      		value: 0,
      		min: 0,
      		max: 14,
      		step: 1,
      		slide: function( event, ui ) {
        		var i = 1;
        		for(i=1;i<16;i++){
        			if(i<=ui.value){
        				$("#buy"+i).css({'background-color':"#9ddcfd"});
        				$("#buy"+i).css({'color':"#01263a"});
        				$("#buy"+i).css({'font-weight':"bold"});
        			}
        			else{
        				$("#buy"+i).css({'background-color':'#efeff1'});
        				$("#buy"+i).css({'font-weight':"normal"});
        				$("#buy"+i).css({'color':"#8a898a"});
        			}
        		}
        		
        		buy_month = getbuymonth(ui.value);
    			change_price();
    			end_date = get_futuremonth_date(start_date,ui.value);
    			change_endtime();
    			
    			change_progress_width(ui.value*10);
    			move_endtips(ui.value*10);
      		}
		});
		
	});
	
	// 点击月份和年份的span
	$(".mm").each(function(n)
	{
		$(this).click(function(){
			var pos = parseInt($(this).attr("selfpos"));
			$( "#slider-range-min" ).slider( "option", "value", pos );
			$( "#slider-range-min" ).val(pos);
			
			for(i=1;i<16;i++){
				if(i<= pos){
					$("#buy"+i).css({'background':'#6cda1b'});
				}
				else{
					$("#buy"+i).css({'background':'#ededed'});
				}
			}
			
			buy_month = getbuymonth(pos);
			change_price();
			end_date = get_futuremonth_date(start_date,pos);
			change_endtime();
			
			change_progress_width(pos*10);
			move_endtips(pos*10);
    			
			
		});

	});
    		
	
	function change_endtime(){
		var tempDate=new Date();
    	tempDate.setTime(end_date*1000);
    	var month = parseInt(tempDate.getMonth()) + 1;
    	var endtime_content = tempDate.getFullYear() + "年" + month + "月" + tempDate.getDate() + "日";
		$("#endtimestr").html(endtime_content);
	}
	
	
	// 改变最终的价格
	function change_price(){
		price = calc_fee();
		$( "#amount" ).html( price +" 元");
		
		// 改变计算公式的数字
		$remain_day 		= calc_remain_time();
		var favor_month 	= get_favor_time(buy_month);
		var newadd_price 	= favor_month * rank_price ;
		var purchased_tc_price = parseInt($("#purchased_tc_price").val());
		if(isNaN(purchased_tc_price)){
			purchased_tc_price = 0;
		}
		
		$str_detail = newadd_price + " + (" + $remain_day + " / 30) * (" + rank_price + " - " + purchased_tc_price + ")";
		$("#cost_detail").html($str_detail);
	}
  
  
  	// 计算价格
	function calc_fee(){
		var remain_day 		= calc_remain_time();
		var favor_month 	= get_favor_time(buy_month);
		var newadd_price 	= favor_month * rank_price ;
		
		
		var purchased_tc_price = parseInt($("#purchased_tc_price").val());
		if(isNaN(purchased_tc_price)){
			purchased_tc_price = 0;
		}
		var remain_month = parseFloat(remain_day/30) ;
		upgrade_money =  Math.floor( (rank_price - purchased_tc_price)  * remain_month );
		var all_price = Math.floor((newadd_price + upgrade_money)* rank_discount);
		
		return all_price;
  	}
  	
  	
  	// 计算之前的已经买了的陶仓剩余的天数
	function calc_remain_time(){
  		var deadline 	= parseInt($("#deadline").val());
  		var current 	= Math.ceil(new Date().getTime()/1000);
  	
  		if(isNaN(deadline)){
  			return 0;
  		}
  		// 原有套餐剩余天数
  		var remain_day = Math.ceil((deadline-current)/(3600*24));
  		if(remain_day < 0){
  			remain_day = 0;
  		}
  		return remain_day;
  	}
  	
  	
  	// 得到优惠的买10月送2月的月数折扣
	function get_favor_time(month_num){
  		if(month_num<=10){
  			return month_num;
  		}
  		if(month_num <=12){
  			return 10;
  		}
  		
  		if(month_num <=22){
  			return month_num - 2;
  		}
  		
  		if(month_num <=24){
  			return 20;
  		}
  		
  		if(month_num <=34){
  			return month_num - 4;
  		}
  		if(month_num <=36){
  			return 30;
  		}
  	}
  	
  	function get_futuremonth_date(now,n){
  		var tempDate=new Date();
  		var newDate = new Date();
  		
	    tempDate.setTime(now*1000);
	    
	    var year = tempDate.getFullYear();
	    var month = tempDate.getMonth();
	    var day = tempDate.getDate();
	    
	    n = parseInt(n);
	    month 	= (month + n)%12;
	    year 	= year + Math.floor((month + n)/12);
	    
	    newDate.setFullYear(year);
		newDate.setMonth(month);
		newDate.setDate(tempDate.getDate());
		newDate.setHours(tempDate.getHours());
		newDate.setMinutes(tempDate.getMinutes());
		newDate.setSeconds(tempDate.getSeconds());
		
		return Date.parse(newDate)/1000;
  	}
  	
  	
  	$("#buy_immediately").click(function() {
        var accId = $("#account_id").val();
        
        if(!accId) {
            alert("您还没有登录，请先登录！");
            window.location.href = "__APP__/User/login";
            return;
        }
        
        if(price == 0){
        	alert("请选择购买时长");
        	return;
        }
        // jump to next confirm
        window.location.href = "__URL__/choose_software_confirm?price=" + price + "&buy_month="+buy_month + "&rank="+ buy_rank+"&upgrade_price="+upgrade_money;
        
    });
    
    // 通过拖动条的月份和年来计算购买的月份数
    function getbuymonth(value){
    	var value_int = parseInt(value);
    	if(value_int  <=  12){
    		return value_int;
    	}
    	var month = (value_int - 11) * 12;
    	return month;
    }
  </script>